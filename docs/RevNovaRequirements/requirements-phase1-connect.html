<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Phase 1 - Connection Wizard | RevNova Requirements</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
        
        .requirements-layout{display:flex;min-height:calc(100vh - 80px);margin-top:80px}
        .sidebar{width:280px;background:#f8f9fa;border-right:1px solid #e0e0e0;padding:2rem 0;position:fixed;left:0;top:80px;height:calc(100vh - 80px);overflow-y:auto;z-index:100}
        .sidebar h3{padding:0 1.5rem;font-size:0.85rem;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin:1.5rem 0 0.5rem}
        .sidebar h3:first-child{margin-top:0}
        .sidebar ul{list-style:none;padding:0;margin:0}
        .sidebar ul li a{display:block;padding:0.6rem 1.5rem;color:#333;text-decoration:none;font-size:0.95rem;transition:all 0.2s}
        .sidebar ul li a:hover{background:#e9ecef;color:#11998e}
        .sidebar ul li a.active{background:#11998e;color:#fff;font-weight:500}
        .sidebar ul ul{padding-left:0}
        .sidebar ul ul li a{padding-left:2.5rem;font-size:0.9rem}
        .main-content{flex:1;margin-left:280px;padding:3rem;background:#fff;min-width:0}
        
        .page-header{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff;padding:3rem;border-radius:12px;margin-bottom:3rem;box-shadow:0 4px 15px rgba(17,153,142,0.2)}
        .page-header h1{margin:0 0 1rem 0;font-size:2.5rem;font-weight:700}
        .page-header p{margin:0;font-size:1.2rem;opacity:0.95}
        
        .section-box{background:#fff;border:2px solid #e0e0e0;padding:2.5rem;margin:2rem 0;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
        .section-box h3{color:#11998e;margin-top:0;border-bottom:2px solid #38ef7d;padding-bottom:0.5rem}
        
        table{width:100%;border-collapse:collapse;margin:1.5rem 0;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
        th,td{border:1px solid #ddd;padding:12px;text-align:left}
        th{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff;font-weight:600;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px}
        tr:hover{background:#f8f9fa}
        
        .wireframe{background:#f8f9fa;border:2px dashed #11998e;padding:2rem;margin:1.5rem 0;border-radius:8px;font-family:monospace;font-size:0.9rem}
        .wireframe h4{margin-top:0;color:#11998e}
        
        .badge{display:inline-block;background:#667eea;color:#fff;padding:0.3rem 0.6rem;border-radius:12px;font-size:0.75rem;font-weight:600;margin:0.2rem;text-transform:uppercase}
        .badge-functional{background:#11998e}
        .badge-technical{background:#e74c3c}
        
        @media (max-width:768px){.sidebar{position:relative;width:100%;height:auto;top:0}.main-content{margin-left:0}.requirements-layout{flex-direction:column}}
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="nav-left">
                <a href="../index.html" class="logo"><div class="logo-box">RevNova</div></a>
                <nav class="main-nav">
                    <ul>
                        <li><a href="../about-revnova.html">About RevNova</a></li>
                        <li><a href="../features.html">Features</a></li>
                        <li><a href="../pricing.html">Pricing</a></li>
                        <li><a href="requirements-home.html" class="active">RevNova Requirements</a></li>
                        <li><a href="../contact.html">Contact</a></li>
                    </ul>
                </nav>
            </div>
            <div class="header-right">
                <div class="country-selector"><span class="fi fi-us"></span></div>
                <a href="../login.html" class="btn btn-login">Login</a>
            </div>
        </div>
    </header>

    <div class="requirements-layout">
        <aside class="sidebar">
            <h3>Platform Vision</h3>
            <ul>
                <li><a href="requirements-home.html">RevNova Vision & Strategy</a></li>
                <li><a href="business-requirements.html">High Level Business Requirements</a></li>
                <li><a href="high-level-functional.html">High Level Functional Design</a></li>
            </ul>
            
            <h3>Phase 1 - Migration Wizard</h3>
            <ul>
                <li><a href="requirements-phase1-connect.html" class="active">1. Connection Wizard</a></li>
                <li><a href="requirements-phase1-analyze.html">2. Schema Analysis</a></li>
                <li><a href="requirements-phase1-mapping.html">3. Field Mapping</a></li>
                <li><a href="requirements-phase1-transform.html">4. Data Transformation</a></li>
                <li><a href="requirements-phase1-validate.html">5. Validation</a></li>
                <li><a href="requirements-phase1-execute.html">6. Migration Execution</a></li>
                <li><a href="requirements-phase1-test.html">7. Post-Migration Testing</a></li>
                <li><a href="requirements-phase1-technical.html">Technical Architecture</a></li>
                <li><a href="requirements-mapping.html">Complete Field Mapping</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>🔌 Page 1: Connection Wizard</h1>
                <p>Establish secure authenticated connections to source (SFDC CPQ) and target (Revenue Cloud) systems</p>
            </div>

            <section class="section-box">
                <h3><span class="badge badge-functional">Functional</span> Overview</h3>
                <p><strong>Purpose:</strong> Enable users to securely connect to their Salesforce CPQ (source) and Salesforce Revenue Cloud (target) environments to initiate the migration process.</p>
                
                <p><strong>User Journey:</strong></p>
                <ol style="line-height:1.8">
                    <li>User lands on Connection Wizard (first page of 7-page migration wizard)</li>
                    <li>User selects source environment type (Production, Sandbox, Developer Edition)</li>
                    <li>User chooses authentication method (OAuth 2.0 recommended, Username/Password fallback)</li>
                    <li>User completes authentication flow (redirected to Salesforce login for OAuth)</li>
                    <li>System tests connection and displays success/failure message</li>
                    <li>User repeats steps 2-4 for target environment (Revenue Cloud)</li>
                    <li>System validates both connections are active</li>
                    <li>User clicks "Next" to proceed to Schema Analysis page</li>
                </ol>
            </section>

            <section class="section-box">
                <h3><span class="badge badge-functional">Functional</span> UI Wireframe</h3>
                <div class="wireframe">
                    <h4>Connection Wizard - Page Layout</h4>
                    <pre>
┌─────────────────────────────────────────────────────────────┐
│  RevNova Migration Wizard                    Step 1 of 7    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  🔌 Connection Wizard                                        │
│  Configure connections to source and target systems          │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ SOURCE CONNECTION: Salesforce CPQ                    │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ Environment Type:  [▼ Production ▼]                 │   │
│  │ Authentication:    [▼ OAuth 2.0 ▼]                  │   │
│  │                                                       │   │
│  │ [ Connect to Salesforce CPQ ]                        │   │
│  │                                                       │   │
│  │ Status: ✅ Connected                                 │   │
│  │ Organization: Acme Corp (00D1234567890ABC)          │   │
│  │ Username: admin@acmecorp.com                         │   │
│  │ Instance: https://acme.my.salesforce.com            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ TARGET CONNECTION: Salesforce Revenue Cloud          │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ Environment Type:  [▼ Sandbox ▼]                    │   │
│  │ Authentication:    [▼ OAuth 2.0 ▼]                  │   │
│  │                                                       │   │
│  │ [ Connect to Revenue Cloud ]                         │   │
│  │                                                       │   │
│  │ Status: ⏳ Not Connected                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
│  [ < Back ]                           [ Test Both ] [ Next >]│
└─────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <section class="section-box">
                <h3><span class="badge badge-functional">Functional</span> Detailed Requirements</h3>
                
                <h4>FR-CONN-001: Environment Type Selection</h4>
                <table>
                    <tr><th>Requirement ID</th><th>Description</th><th>Acceptance Criteria</th></tr>
                    <tr>
                        <td>FR-CONN-001.1</td>
                        <td>System shall provide dropdown to select source environment type</td>
                        <td>Dropdown includes: Production, Sandbox, Developer Edition</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-001.2</td>
                        <td>System shall provide dropdown to select target environment type</td>
                        <td>Dropdown includes: Production, Sandbox, Developer Edition</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-001.3</td>
                        <td>System shall display warning if both source and target are Production</td>
                        <td>Modal warning: "Caution: Migrating between production environments. Recommend using sandbox for testing first."</td>
                    </tr>
                </table>

                <h4>FR-CONN-002: Authentication Methods</h4>
                <table>
                    <tr><th>Requirement ID</th><th>Description</th><th>Acceptance Criteria</th></tr>
                    <tr>
                        <td>FR-CONN-002.1</td>
                        <td>System shall support OAuth 2.0 authentication (recommended)</td>
                        <td>OAuth flow redirects to Salesforce login, returns with auth token, no credentials stored in RevNova</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-002.2</td>
                        <td>System shall support Username/Password authentication (fallback)</td>
                        <td>Form fields for Username, Password, Security Token. Credentials encrypted at rest using AES-256</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-002.3</td>
                        <td>System shall default to OAuth 2.0 and display "More secure" badge</td>
                        <td>OAuth option pre-selected, badge visible, tooltip explains security benefits</td>
                    </tr>
                </table>

                <h4>FR-CONN-003: Connection Testing</h4>
                <table>
                    <tr><th>Requirement ID</th><th>Description</th><th>Acceptance Criteria</th></tr>
                    <tr>
                        <td>FR-CONN-003.1</td>
                        <td>System shall test connection immediately after authentication</td>
                        <td>API call to UserInfo endpoint, verify valid response within 10 seconds</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-003.2</td>
                        <td>System shall display connection status with visual indicators</td>
                        <td>✅ Green checkmark for success, ❌ Red X for failure, ⏳ Spinner for in-progress</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-003.3</td>
                        <td>System shall display organization details upon successful connection</td>
                        <td>Show: Org Name, Org ID (15-char), Username, Instance URL</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-003.4</td>
                        <td>System shall display error message with troubleshooting steps on failure</td>
                        <td>Error message includes: reason (invalid credentials, network timeout, API limit), suggested actions (retry, check credentials, contact support)</td>
                    </tr>
                </table>

                <h4>FR-CONN-004: Credential Management</h4>
                <table>
                    <tr><th>Requirement ID</th><th>Description</th><th>Acceptance Criteria</th></tr>
                    <tr>
                        <td>FR-CONN-004.1</td>
                        <td>System shall save connection details for reuse in future sessions</td>
                        <td>User can check "Remember this connection" checkbox, connection saved to user profile</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-004.2</td>
                        <td>System shall allow users to view saved connections</td>
                        <td>"Saved Connections" dropdown shows previously configured connections with org name + username</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-004.3</td>
                        <td>System shall allow users to delete saved connections</td>
                        <td>Trash icon next to each saved connection, confirmation modal before deletion</td>
                    </tr>
                </table>

                <h4>FR-CONN-005: Navigation</h4>
                <table>
                    <tr><th>Requirement ID</th><th>Description</th><th>Acceptance Criteria</th></tr>
                    <tr>
                        <td>FR-CONN-005.1</td>
                        <td>System shall disable "Next" button until both connections are successful</td>
                        <td>Button grayed out with tooltip: "Complete both source and target connections to proceed"</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-005.2</td>
                        <td>System shall enable "Next" button when both connections are active</td>
                        <td>Button becomes green, clickable, navigates to Schema Analysis page</td>
                    </tr>
                    <tr>
                        <td>FR-CONN-005.3</td>
                        <td>System shall display progress indicator showing "Step 1 of 7"</td>
                        <td>Progress bar at top of page shows 14% complete (1/7), page title includes step number</td>
                    </tr>
                </table>
            </section>

            <section class="section-box">
                <h3><span class="badge badge-technical">Technical</span> Architecture & Implementation</h3>
                
                <h4>TA-CONN-001: OAuth 2.0 Flow</h4>
                <table>
                    <tr><th>Component</th><th>Technology</th><th>Implementation Details</th></tr>
                    <tr>
                        <td>OAuth Client</td>
                        <td>Node.js, Passport.js, Salesforce OAuth Strategy</td>
                        <td>
                            • Consumer Key/Secret stored in environment variables<br>
                            • Callback URL: https://revnova.app/auth/callback<br>
                            • Scopes: api, refresh_token, web<br>
                            • Token refresh logic: auto-refresh 5 min before expiry
                        </td>
                    </tr>
                    <tr>
                        <td>Token Storage</td>
                        <td>PostgreSQL encrypted column, AES-256-GCM</td>
                        <td>
                            • Table: user_connections (user_id, org_id, access_token, refresh_token, instance_url, expires_at)<br>
                            • Encryption key rotated every 90 days<br>
                            • Tokens never logged or displayed in UI
                        </td>
                    </tr>
                    <tr>
                        <td>Session Management</td>
                        <td>Redis session store, 24-hour TTL</td>
                        <td>
                            • Session includes: connection_id, org_name, username<br>
                            • Auto-logout after 24 hours of inactivity<br>
                            • Re-authentication required on session expiry
                        </td>
                    </tr>
                </table>

                <h4>TA-CONN-002: Connection Testing API</h4>
                <pre style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:8px;overflow-x:auto">
POST /api/v1/connections/test
Content-Type: application/json

Request Body:
{
  "connection_id": "conn_abc123",
  "environment_type": "production"
}

Response (Success):
{
  "status": "success",
  "connection_details": {
    "org_id": "00D1234567890ABC",
    "org_name": "Acme Corp",
    "username": "admin@acmecorp.com",
    "instance_url": "https://acme.my.salesforce.com",
    "api_version": "v59.0",
    "org_type": "Production"
  },
  "test_timestamp": "2025-10-30T14:23:45Z"
}

Response (Failure):
{
  "status": "error",
  "error_code": "INVALID_CREDENTIALS",
  "error_message": "Authentication failed: Invalid username, password, or security token",
  "troubleshooting_steps": [
    "Verify username and password are correct",
    "Append security token to password if using username/password auth",
    "Check if IP restrictions are configured in Salesforce",
    "Try OAuth 2.0 authentication instead"
  ]
}
                </pre>

                <h4>TA-CONN-003: Database Schema</h4>
                <pre style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:8px;overflow-x:auto">
CREATE TABLE user_connections (
    connection_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id),
    connection_type VARCHAR(20) NOT NULL CHECK (connection_type IN ('source', 'target')),
    environment_type VARCHAR(20) NOT NULL CHECK (environment_type IN ('production', 'sandbox', 'developer')),
    auth_method VARCHAR(20) NOT NULL CHECK (auth_method IN ('oauth', 'username_password')),
    
    -- OAuth fields (encrypted)
    access_token TEXT,  -- AES-256-GCM encrypted
    refresh_token TEXT, -- AES-256-GCM encrypted
    token_expires_at TIMESTAMP,
    
    -- Organization details
    org_id VARCHAR(18) NOT NULL,
    org_name VARCHAR(255),
    instance_url VARCHAR(255) NOT NULL,
    username VARCHAR(255) NOT NULL,
    
    -- Metadata
    is_active BOOLEAN DEFAULT true,
    last_tested_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, org_id, connection_type)
);

CREATE INDEX idx_user_connections_user_id ON user_connections(user_id);
CREATE INDEX idx_user_connections_org_id ON user_connections(org_id);
                </pre>

                <h4>TA-CONN-004: Error Handling</h4>
                <table>
                    <tr><th>Error Type</th><th>HTTP Status</th><th>Handling Strategy</th></tr>
                    <tr>
                        <td>Invalid Credentials</td>
                        <td>401 Unauthorized</td>
                        <td>Display user-friendly error message, suggest checking credentials, offer "Forgot Password?" link</td>
                    </tr>
                    <tr>
                        <td>Network Timeout</td>
                        <td>504 Gateway Timeout</td>
                        <td>Auto-retry up to 3 times with exponential backoff (1s, 2s, 4s), suggest checking internet connection</td>
                    </tr>
                    <tr>
                        <td>API Rate Limit</td>
                        <td>429 Too Many Requests</td>
                        <td>Display wait time from Retry-After header, auto-retry after wait period, suggest upgrading Salesforce API limits</td>
                    </tr>
                    <tr>
                        <td>Insufficient Permissions</td>
                        <td>403 Forbidden</td>
                        <td>Display required permissions list (API Enabled, View All Data), link to Salesforce help article on permission sets</td>
                    </tr>
                </table>

                <h4>TA-CONN-005: Security Requirements</h4>
                <ul style="line-height:1.8">
                    <li><strong>Encryption at Rest:</strong> All credentials encrypted using AES-256-GCM with unique salt per record</li>
                    <li><strong>Encryption in Transit:</strong> TLS 1.3 for all API calls, certificate pinning for Salesforce endpoints</li>
                    <li><strong>Token Rotation:</strong> Access tokens refreshed every 2 hours, refresh tokens rotated every 90 days</li>
                    <li><strong>Audit Logging:</strong> All connection attempts logged with timestamp, user_id, IP address, success/failure</li>
                    <li><strong>IP Whitelisting:</strong> Support for configuring trusted IP ranges in Salesforce Connected App</li>
                    <li><strong>MFA Support:</strong> OAuth flow supports Salesforce MFA, no additional configuration needed</li>
                </ul>
            </section>

            <section class="section-box">
                <h3>Acceptance Criteria Summary</h3>
                <ol style="line-height:1.8">
                    <li>✅ User can authenticate to both source and target environments using OAuth 2.0 or Username/Password</li>
                    <li>✅ Connection status is displayed with clear visual indicators (✅ success, ❌ failure)</li>
                    <li>✅ Organization details (name, ID, username, instance URL) are displayed after successful connection</li>
                    <li>✅ Comprehensive error messages with troubleshooting steps are shown on connection failure</li>
                    <li>✅ Credentials are encrypted at rest using AES-256-GCM and never displayed in UI</li>
                    <li>✅ Saved connections can be reused in future sessions</li>
                    <li>✅ "Next" button is disabled until both connections are successful</li>
                    <li>✅ OAuth tokens are auto-refreshed before expiry</li>
                    <li>✅ All connection attempts are audit logged</li>
                    <li>✅ Page displays "Step 1 of 7" progress indicator</li>
                </ol>
            </section>

            <section>
                <h2>Navigation</h2>
                <ul style="line-height:2">
                    <li><strong>Previous:</strong> <a href="requirements-home.html">RevNova Vision & Strategy</a></li>
                    <li><strong>Next:</strong> <a href="requirements-phase1-analyze.html">Page 2: Schema Analysis</a></li>
                    <li><strong>Back to:</strong> <a href="high-level-functional.html">High Level Functional Design</a></li>
                </ul>
            </section>
        </main>
    </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dev1 Day 23: Testing Reports API - RevNova Onboarding</title>
    <link rel="stylesheet" href="../styles.css">
    <style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,sans-serif}.main-content{margin-left:280px;padding:2.5rem}.day-header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;padding:1.5rem;border-radius:10px;margin-bottom:1rem}.step-card{background:#fff;border:1px solid #e0e0e0;padding:1rem;border-radius:8px;margin-bottom:1rem}.nav-buttons{display:flex;justify-content:space-between;margin-top:1.5rem}</style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="nav-left">
                <a href="../index.html" class="logo"><div class="logo-box">RevNova</div></a>
                <nav class="main-nav">
                    <ul>
                        <li><a href="onboarding-home.html" class="active">Onboarding</a></li>
                        <li><a href="../about-revnova.html">About RevNova</a></li>
                        <li><a href="../features.html">Features</a></li>
                        <li><a href="../pricing.html">Pricing</a></li>
                        <li><a href="../RevNovaRequirements/requirements-home.html">RevNova Requirements</a></li>
                        <li><a href="../contact.html">Contact</a></li>
                    </ul>
                </nav>
            </div>
            <div class="header-right">
                <div class="country-selector"><span class="fi fi-us"></span></div>
                <a href="../login.html" class="btn btn-login">Login</a>
            </div>
        </div>
    </header>

    <div class="onboarding-layout">
        <aside class="sidebar">
            <h3>Getting Started</h3>
            <ul>
                <li><a href="onboarding-home.html">Onboarding Home</a></li>
                <li><a href="onboarding-overview.html">Project Overview</a></li>
            </ul>
            
            <h3>Developer 1: Daily Tasks</h3>
            <ul>
                <li class="has-children"><span style="font-weight:600;color:#333;">Week 1: Backend Setup</span>
                    <ul>
                        <li><a href="dev1-day01.html">Day 1</a></li>
                        <li><a href="dev1-day02.html">Day 2</a></li>
                        <li><a href="dev1-day03.html">Day 3</a></li>
                        <li><a href="dev1-day04.html">Day 4</a></li>
                        <li><a href="dev1-day05.html">Day 5</a></li>
                    </ul>
                </li>
                <li class="has-children"><span style="font-weight:600;color:#333;">Week 2: Salesforce Integration</span>
                    <ul>
                        <li><a href="dev1-day06.html">Day 6</a></li>
                        <li><a href="dev1-day07.html">Day 7</a></li>
                        <li><a href="dev1-day08.html">Day 8</a></li>
                        <li><a href="dev1-day09.html">Day 9</a></li>
                        <li><a href="dev1-day10.html">Day 10</a></li>
                    </ul>
                </li>
                <li class="has-children"><span style="font-weight:600;color:#333;">Week 3: Field Mapping API</span>
                    <ul>
                        <li><a href="dev1-day11.html">Day 11</a></li>
                        <li><a href="dev1-day12.html">Day 12</a></li>
                        <li><a href="dev1-day13.html">Day 13</a></li>
                        <li><a href="dev1-day14.html">Day 14</a></li>
                        <li><a href="dev1-day15.html">Day 15</a></li>
                    </ul>
                </li>
                <li class="has-children"><span style="font-weight:600;color:#333;">Week 4: Transformation & Queue</span>
                    <ul>
                        <li><a href="dev1-day16.html">Day 16</a></li>
                        <li><a href="dev1-day17.html">Day 17</a></li>
                        <li><a href="dev1-day18.html">Day 18</a></li>
                        <li><a href="dev1-day19.html">Day 19</a></li>
                        <li><a href="dev1-day20.html">Day 20</a></li>
                    </ul>
                </li>
                <li class="has-children"><span style="font-weight:600;color:#333;">Week 5: Execution & Testing</span>
                    <ul>
                        <li><a href="dev1-day21.html">Day 21</a></li>
                        <li><a href="dev1-day22.html">Day 22</a></li>
                        <li><a href="dev1-day23.html">Day 23</a></li>
                        <li><a href="dev1-day24.html">Day 24</a></li>
                        <li><a href="dev1-day25.html">Day 25</a></li>
                    </ul>
                </li>
            </ul>
        </aside>

        <main class="main-content">
        <div class="day-header"><h1>Day 23: Testing Reports API</h1><p>Developer 1 ‚Äî Backend & Database | Week 5/5</p></div>

        <div class="step-card" style="background:#fffbea;border-left:4px solid #f59e0b;">
            <h2>‚ö†Ô∏è IMPORTANT: Start of Day Checklist</h2>
            <p><strong>Before starting today's work, run these commands:</strong></p>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;">
cd C:\Dev\RevNovaRepository<br>
git pull origin main
            </div>
            <p>This ensures you have the latest code from your teammates. Always pull before starting work!</p>
        </div>

        <div class="step-card" style="background:#e8f5e9;border-left:4px solid #4caf50;">
            <h2>ü§ñ Enhanced Copilot Prompt</h2>
            <div style="background:#f5f5f5;padding:1.5rem;border-radius:6px;margin:1rem 0;border-left:3px solid #4caf50;">
<pre style="white-space:pre-wrap;font-family:monospace;font-size:0.9em;line-height:1.6;margin:0;">
<strong>Day 23 - RevNova Backend - Testing Reports API</strong>

<strong>üéØ REVNOVA:</strong> Migration reports with source vs target comparison, field-level diffs, success/error stats
<strong>üìö REQUIREMENTS:</strong> <a href="../RevNovaRequirements/reporting.html" target="_blank">docs/RevNovaRequirements/reporting.html</a>
<strong>üèóÔ∏è MVP STATUS:</strong> Week 5/5 (Nov 30 deadline - 18 days remaining)
<strong>TECH:</strong> Node.js + Express + PostgreSQL + jsforce SOQL queries + CSV export

<strong>TODAY'S GOAL:</strong> Build testing reports API: GET /api/migrations/:id/report that compares source (STG1) vs target Salesforce data, generates field-level diffs, calculates success rates, exports to JSON/CSV.

<strong>TASKS:</strong>
1. <strong>Create MigrationReportService</strong> (backend/src/services/migration-report.service.ts)
   - generateReport(migrationId): Promise&lt;MigrationReport&gt;
   - Compare record counts: STG1 vs target Salesforce
   - Field-level diff: query target records, compare with STG1 data
   - Calculate: successRate = (successCount/totalRecords) * 100
   - Return: { summary: { total, success, errors }, fieldDiffs: Array, recordDetails: Array }

2. <strong>GET /api/migrations/:id/report endpoint</strong>
   - Query migration_execution_logs for stats
   - Call MigrationReportService.generateReport()
   - Support ?format=json|csv query parameter
   - Return JSON by default, CSV for downloads

3. <strong>Field-level comparison logic</strong>
   - For each successfully migrated record: SOQL query target record
   - Compare STG1 field values with target field values
   - Identify mismatches: { recordId, field, expected, actual, status: 'MATCH'|'MISMATCH' }
   - Handle null values, type conversions (string ‚Üí number)

4. <strong>CSV export functionality</strong>
   - Use csv-writer npm package
   - Format: recordId, objectType, status, errorMessage, field1, field2...
   - Set Content-Disposition header: attachment; filename=migration-report-{id}.csv

Guide me step-by-step through building the testing reports API with source/target comparison and CSV export.
</pre>
            </div>
        </div>

        <div class="step-card">
            <h2>Step 1: Create MigrationReportService</h2>
            <p><strong>File:</strong> <code>backend/src/services/migration-report.service.ts</code></p>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;">
<pre style="margin:0;white-space:pre-wrap;">
export interface MigrationReport {
  summary: {
    totalRecords: number;
    successCount: number;
    failureCount: number;
    successRate: number;
  };
  fieldDiffs: Array&lt;{
    recordId: string;
    field: string;
    expected: any;
    actual: any;
    status: 'MATCH' | 'MISMATCH';
  }&gt;;
  recordDetails: Array&lt;{
    recordId: string;
    objectType: string;
    status: 'SUCCESS' | 'FAILED';
    errorMessage?: string;
  }&gt;;
}

export class MigrationReportService {
  constructor(private db: Pool, private connection: jsforce.Connection) {}

  async generateReport(migrationId: string): Promise&lt;MigrationReport&gt; {
    // Get execution logs
    const logsResult = await this.db.query(
      'SELECT * FROM migration_execution_logs WHERE migration_id = $1 ORDER BY created_at DESC LIMIT 1',
      [migrationId]
    );
    
    if (logsResult.rows.length === 0) {
      throw new Error('No execution logs found');
    }
    
    const log = logsResult.rows[0];
    const errors = log.errors_json || [];
    
    // Get successful records from STG1
    const stg1Products = await this.db.query(
      'SELECT * FROM STG1_PRODUCTS WHERE migration_id = $1 AND salesforce_id IS NOT NULL',
      [migrationId]
    );
    
    // Compare with target Salesforce
    const fieldDiffs = await this.compareFields(stg1Products.rows);
    
    return {
      summary: {
        totalRecords: log.total_records,
        successCount: log.success_count,
        failureCount: log.failure_count,
        successRate: (log.success_count / log.total_records) * 100
      },
      fieldDiffs,
      recordDetails: this.buildRecordDetails(stg1Products.rows, errors)
    };
  }

  private async compareFields(stg1Records: any[]): Promise&lt;any[]&gt; {
    const diffs = [];
    
    for (const record of stg1Records) {
      const targetRecord = await this.connection.sobject('Product2').retrieve(record.salesforce_id);
      
      // Compare key fields
      const fieldsToCompare = ['Name', 'ProductCode', 'Description', 'IsActive'];
      
      for (const field of fieldsToCompare) {
        const expected = record[field.toLowerCase()];
        const actual = targetRecord[field];
        
        diffs.push({
          recordId: record.salesforce_id,
          field,
          expected,
          actual,
          status: expected === actual ? 'MATCH' : 'MISMATCH'
        });
      }
    }
    
    return diffs;
  }
  
  private buildRecordDetails(stg1Records: any[], errors: any[]): any[] {
    const errorMap = new Map(errors.map(e =&gt; [e.recordId, e.error]));
    
    return stg1Records.map(record =&gt; ({
      recordId: record.salesforce_id || record.id,
      objectType: 'Product2',
      status: errorMap.has(record.id) ? 'FAILED' : 'SUCCESS',
      errorMessage: errorMap.get(record.id)
    }));
  }
}
</pre>
            </div>
        </div>

        <div class="step-card">
            <h2>Step 2: Create GET /api/migrations/:id/report Endpoint</h2>
            <p><strong>File:</strong> <code>backend/src/routes/migrations.routes.ts</code></p>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;">
<pre style="margin:0;white-space:pre-wrap;">
import { createObjectCsvWriter } from 'csv-writer';

router.get('/:id/report', async (req: Request, res: Response) =&gt; {
  const { id } = req.params;
  const { format = 'json' } = req.query;
  
  try {
    const connection = await getSalesforceConnection(id);
    const reportService = new MigrationReportService(db, connection);
    
    const report = await reportService.generateReport(id);
    
    if (format === 'csv') {
      // Generate CSV
      const csvPath = `./reports/migration-${id}.csv`;
      const csvWriter = createObjectCsvWriter({
        path: csvPath,
        header: [
          { id: 'recordId', title: 'Record ID' },
          { id: 'objectType', title: 'Object Type' },
          { id: 'status', title: 'Status' },
          { id: 'errorMessage', title: 'Error Message' }
        ]
      });
      
      await csvWriter.writeRecords(report.recordDetails);
      
      res.download(csvPath, `migration-report-${id}.csv`);
    } else {
      res.json(report);
    }
  } catch (error) {
    logger.error('Generate report error:', error);
    res.status(500).json({ error: 'Failed to generate report' });
  }
});
</pre>
            </div>
        </div>

        <div class="step-card" style="background:#e3f2fd;border-left:4px solid #2196f3;">
            <h2>‚úÖ Acceptance Criteria</h2>
            <ul style="line-height:1.8;">
                <li>‚úÖ GET /api/migrations/:id/report returns summary statistics</li>
                <li>‚úÖ Field-level comparison: STG1 vs target Salesforce data</li>
                <li>‚úÖ Success rate calculation: (successCount/totalRecords) * 100</li>
                <li>‚úÖ CSV export with ?format=csv query parameter</li>
                <li>‚úÖ Record-level details with error messages</li>
            </ul>
        </div>
        <div class="nav-buttons"><a href="dev1-day22.html" class="nav-btn back">‚Üê Back to Day 22</a><a href="dev1-day24.html" class="nav-btn next">Next: Day 24 ‚Üí</a></div>
            </main>
    </div>
    <script src="../script.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dev1 Day 19: ETL Job Processing - RevNova Onboarding</title>
    <link rel="stylesheet" href="../styles.css">
    <style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,sans-serif}.main-content{margin-left:280px;padding:2.5rem}.day-header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;padding:1.5rem;border-radius:10px;margin-bottom:1rem}.step-card{background:#fff;border:1px solid #e0e0e0;padding:1rem;border-radius:8px;margin-bottom:1rem}.nav-buttons{display:flex;justify-content:space-between;margin-top:1.5rem}</style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="nav-left">
                <a href="../index.html" class="logo"><div class="logo-box">RevNova</div></a>
                <nav class="main-nav">
                    <ul>
                        <li><a href="onboarding-home.html" class="active">Onboarding</a></li>
                        <li><a href="../about-revnova.html">About RevNova</a></li>
                        <li><a href="../features.html">Features</a></li>
                        <li><a href="../pricing.html">Pricing</a></li>
                        <li><a href="../RevNovaRequirements/requirements-home.html">RevNova Requirements</a></li>
                        <li><a href="../contact.html">Contact</a></li>
                    </ul>
                </nav>
            </div>
            <div class="header-right">
                <div class="country-selector"><span class="fi fi-us"></span></div>
                <a href="../login.html" class="btn btn-login">Login</a>
            </div>
        </div>
    </header>

    <div class="onboarding-layout">
        <aside class="sidebar">
            <h3>Getting Started</h3>
            <ul>
                <li><a href="onboarding-home.html">Onboarding Home</a></li>
                <li><a href="onboarding-overview.html">Project Overview</a></li>
            </ul>
            
            <h3>Developer 1: Daily Tasks</h3>
            <ul>
                <li class="has-children"><span style="font-weight:600;color:#333;cursor:default;display:block;padding:0.6rem 0;">Week 1: Backend Setup</span>
                    <ul>
                        <li><a href="dev1-day01.html">Day 1</a></li>
                        <li><a href="dev1-day02.html">Day 2</a></li>
                        <li><a href="dev1-day03.html">Day 3</a></li>
                        <li><a href="dev1-day04.html">Day 4</a></li>
                        <li><a href="dev1-day05.html">Day 5</a></li>
                    </ul>
                </li>
                <li class="has-children"><span style="font-weight:600;color:#333;cursor:default;display:block;padding:0.6rem 0;">Week 2: Salesforce Integration</span>
                    <ul>
                        <li><a href="dev1-day06.html">Day 6</a></li>
                        <li><a href="dev1-day07.html">Day 7</a></li>
                        <li><a href="dev1-day08.html">Day 8</a></li>
                        <li><a href="dev1-day09.html">Day 9</a></li>
                        <li><a href="dev1-day10.html">Day 10</a></li>
                    </ul>
                </li>
                <li class="has-children"><span style="font-weight:600;color:#333;cursor:default;display:block;padding:0.6rem 0;">Week 3: Field Mapping API</span>
                    <ul>
                        <li><a href="dev1-day11.html">Day 11</a></li>
                        <li><a href="dev1-day12.html">Day 12</a></li>
                        <li><a href="dev1-day13.html">Day 13</a></li>
                        <li><a href="dev1-day14.html">Day 14</a></li>
                        <li><a href="dev1-day15.html">Day 15</a></li>
                    </ul>
                </li>
                <li class="has-children"><span style="font-weight:600;color:#333;cursor:default;display:block;padding:0.6rem 0;">Week 4: Transformation & Queue</span>
                    <ul>
                        <li><a href="dev1-day16.html">Day 16</a></li>
                        <li><a href="dev1-day17.html">Day 17</a></li>
                        <li><a href="dev1-day18.html">Day 18</a></li>
                        <li><a href="dev1-day19.html">Day 19</a></li>
                        <li><a href="dev1-day20.html">Day 20</a></li>
                    </ul>
                </li>
                <li class="has-children"><span style="font-weight:600;color:#333;cursor:default;display:block;padding:0.6rem 0;">Week 5: Execution & Testing</span>
                    <ul>
                        <li><a href="dev1-day21.html">Day 21</a></li>
                        <li><a href="dev1-day22.html">Day 22</a></li>
                        <li><a href="dev1-day23.html">Day 23</a></li>
                        <li><a href="dev1-day24.html">Day 24</a></li>
                        <li><a href="dev1-day25.html">Day 25</a></li>
                    </ul>
                </li>
            </ul>
        </aside>

        <main class="main-content">
        <div class="day-header">
            <h1>‚ùå Day 19: Inflight Quotes API - NOT STARTED</h1>
            <p>Developer 1 ‚Äî Backend & Database</p>
            <p style="background:#fee2e2;padding:0.5rem;border-radius:4px;margin-top:0.5rem;"><strong>Note:</strong> Inflight quotes migration endpoints not implemented</p>
        </div>

        <div class="step-card" style="background:#fffbea;border-left:4px solid #f59e0b;">
            <h2>‚ö†Ô∏è IMPORTANT: Start of Day Checklist</h2>
            <p><strong>Before starting today's work, run these commands:</strong></p>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;">
cd C:\Dev\RevNovaRepository<br>
git pull origin main
            </div>
            <p>This ensures you have the latest code from your teammates. Always pull before starting work!</p>
        </div>

        <div class="step-card" style="background:#e0f2fe;border-left:4px solid #0284c7;">
            <h2>ü§ñ Copy This Prompt for Your GitHub Copilot</h2>
            <p><strong>Click the code block below, copy all text, and paste into GitHub Copilot Chat to get step-by-step guidance:</strong></p>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;font-size:0.85rem;max-height:400px;overflow-y:auto;">
I'm working on Day 19 of the RevNova migration platform - Backend Developer track.<br><br>

**üéØ REVNOVA PLATFORM OVERVIEW:**<br>
RevNova migrates Salesforce CPQ ‚Üí Revenue Cloud with an 11-step wizard (Connect ‚Üí Analyze ‚Üí Map ‚Üí Transform ‚Üí Validate ‚Üí Execute ‚Üí Test ‚Üí Report ‚Üí Inflight Quotes ‚Üí Inflight Orders ‚Üí Contracts ‚Üí Subscriptions ‚Üí Final Report). Days 1-18 completed core product catalog migration. Days 19-22 add inflight business data migration.<br><br>

**Tech Stack:** Node.js 20, Express, TypeScript, PostgreSQL 16, Redis 7, Bull queue, jsforce, OpenAI GPT-4 API<br><br>

**üìö PHASE 1 REQUIREMENTS - READ THESE FIRST:**<br>
- docs/RevNovaRequirements/requirements-phase1-inflight.html (BR-IQ-001 to BR-IQ-004 functional requirements)<br>
- docs/RevNovaRequirements/requirements-phase1-technical.html (database schema, API specs)<br>
- docs/Mockup/migration-inflight-quotes.html (UI design showing 247 draft, 89 pending, 56 negotiating quotes)<br><br>

**Context from Previous Days:**<br>
- Days 1-10: Backend API, PostgreSQL, jsforce Salesforce integration, OAuth<br>
- Days 11-15: Field mapping API with OpenAI GPT-4 suggestions<br>
- Days 16-18: Transformation engine, Bull queue, async job processing<br>
- ‚úÖ Core product catalog migration (products, price books, pricing rules) COMPLETE<br><br>

**Today's Goal:** Build Inflight Quotes Migration API - migrate quotes in Draft/Pending/Negotiating status to Revenue Cloud<br><br>

**Business Requirements (from requirements-phase1-inflight.html):**<br>
- BR-IQ-001: Detect quotes with Status = 'Draft', 'Pending', or 'In Negotiation'<br>
- BR-IQ-002: Migrate quote line items with product references<br>
- BR-IQ-003: Preserve approval history with timestamps and comments<br>
- BR-IQ-004: Maintain quote-to-opportunity relationships<br><br>

**Tasks:**<br>
1. Create database table: inflight_quote_migrations (migrationId, sourceQuoteId, targetQuoteId, quoteStatus, lineItemCount, approvalSteps)<br>
2. POST /api/v1/migration/inflight-quotes/analyze - Query CPQ org for quotes WHERE Status IN ('Draft', 'Pending Approval', 'In Negotiation')<br>
3. Return: { draftCount, pendingCount, negotiatingCount, quotes: [{ id, name, status, lineItems, approvalSteps, opportunityId }] }<br>
4. POST /api/v1/migration/inflight-quotes/execute - Migrate quotes with options: { preserveLineItems, preserveApprovalHistory, linkOpportunities, convertPricingRules }<br>
5. Use jsforce to query SBQQ__Quote__c object, related SBQQ__QuoteLine__c records, approval process history (ProcessInstance)<br>
6. Insert transformed quotes into Revenue Cloud using jsforce bulk API<br>
7. Track migration status in inflight_quote_migrations table<br><br>

**Database Schema:**<br>
```sql<br>
CREATE TABLE inflight_quote_migrations (<br>
&nbsp;&nbsp;id UUID PRIMARY KEY DEFAULT gen_random_uuid(),<br>
&nbsp;&nbsp;migration_id UUID REFERENCES migrations(id),<br>
&nbsp;&nbsp;source_quote_id VARCHAR(18) NOT NULL,<br>
&nbsp;&nbsp;target_quote_id VARCHAR(18),<br>
&nbsp;&nbsp;quote_status VARCHAR(50),<br>
&nbsp;&nbsp;line_item_count INTEGER DEFAULT 0,<br>
&nbsp;&nbsp;approval_steps INTEGER DEFAULT 0,<br>
&nbsp;&nbsp;migrated_at TIMESTAMP,<br>
&nbsp;&nbsp;created_at TIMESTAMP DEFAULT NOW()<br>
);<br>
```<br><br>

**API Endpoints:**<br>
POST /api/v1/migration/inflight-quotes/analyze ‚Üí { draftCount, pendingCount, negotiatingCount, quotes[] }<br>
POST /api/v1/migration/inflight-quotes/execute ‚Üí { jobId, status, quotesProcessed }<br><br>

**Acceptance Criteria:**<br>
- Analyze endpoint returns quote counts by status (Draft, Pending, Negotiating)<br>
- Execute endpoint migrates quotes with line items and approval history<br>
- Quote-to-opportunity relationships preserved<br>
- Custom pricing and discounts maintained<br>
- Database tracks migration status per quote<br><br>

**Testing:**<br>
- curl POST /api/v1/migration/inflight-quotes/analyze returns { draftCount: 247, pendingCount: 89, negotiatingCount: 56 }<br>
- curl POST /api/v1/migration/inflight-quotes/execute with options returns jobId<br>
- Check inflight_quote_migrations table has records<br>
- Verify Revenue Cloud org has migrated quotes with correct status<br><br>

Please guide me step-by-step through implementing this inflight quotes migration API. Show me the database migration, service layer, routes, and how to query/migrate quotes with line items and approval history.
            </div>
        </div>

<div class="step-card">
            <h2>üìã Objective</h2>
            <p>Build API endpoints to analyze and migrate CPQ quotes that are in-progress (Draft, Pending Approval, In Negotiation).</p>
        </div>

        <div class="step-card">
            <h2>üóÑÔ∏è Step 1: Create Database Migration</h2>
            <p>Create migration file <code>backend/src/migrations/007_create_inflight_quote_migrations.sql</code>:</p>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;">
import { Connection } from '@jsforce/jsforce-node';<br>
import { redisClient } from '../config/redis';<br>
import { pool } from '../config/database';<br>
import { TransformService } from './transformService';<br>
import { Transform } from '../types/transform.types';<br><br>

export class ETLService {<br>
&nbsp;&nbsp;private transformService = new TransformService();<br><br>

&nbsp;&nbsp;async extractFromSalesforce(connectionId: string, objectName: string, limit = 1000) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;// Get connection from Redis<br>
&nbsp;&nbsp;&nbsp;&nbsp;const connData = await redisClient.get(`connection:${connectionId}`);<br>
&nbsp;&nbsp;&nbsp;&nbsp;if (!connData) throw new Error('Connection not found');<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;const { accessToken, instanceUrl } = JSON.parse(connData);<br>
&nbsp;&nbsp;&nbsp;&nbsp;const conn = new Connection({ accessToken, instanceUrl });<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;// Query records<br>
&nbsp;&nbsp;&nbsp;&nbsp;console.log(`Extracting from ${objectName} (limit: ${limit})...`);<br>
&nbsp;&nbsp;&nbsp;&nbsp;const result = await conn.query(`SELECT * FROM ${objectName} LIMIT ${limit}`);<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;console.log(`Extracted ${result.records.length} records`);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return result.records;<br>
&nbsp;&nbsp;}<br><br>

&nbsp;&nbsp;async transformRecords(<br>
&nbsp;&nbsp;&nbsp;&nbsp;records: any[],<br>
&nbsp;&nbsp;&nbsp;&nbsp;transforms: Transform[],<br>
&nbsp;&nbsp;&nbsp;&nbsp;connectionId: string<br>
&nbsp;&nbsp;) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;const transformed = [];<br>
&nbsp;&nbsp;&nbsp;&nbsp;const errors = [];<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;for (let i = 0; i &lt; records.length; i++) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const record = records[i];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const transformedRecord: Record&lt;string, any&gt; = { source_id: record.Id };<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (const transform of transforms) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const value = await this.transformService.applyTransform(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;record,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transform,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connectionId<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transformedRecord[transform.targetField] = value;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transformed.push(transformedRecord);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (error: any) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errors.push({ id: record.Id, error: error.message });<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;return { transformed, errors };<br>
&nbsp;&nbsp;}<br><br>

&nbsp;&nbsp;async loadToStaging(migrationId: string, records: any[]) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;const client = await pool.connect();<br>
&nbsp;&nbsp;&nbsp;&nbsp;try {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await client.query('BEGIN');<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (const record of records) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await client.query(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'INSERT INTO stg1_records (migration_id, source_id, data) VALUES ($1, $2, $3)',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[migrationId, record.source_id, JSON.stringify(record)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await client.query('COMMIT');<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(`Loaded ${records.length} records to STG1`);<br>
&nbsp;&nbsp;&nbsp;&nbsp;} catch (error) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await client.query('ROLLBACK');<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw error;<br>
&nbsp;&nbsp;&nbsp;&nbsp;} finally {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client.release();<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;}<br>
}
            </div>
        </div>

        <div class="step-card">
            <h2>‚öôÔ∏è Step 2: Update Migration Worker with ETL Logic</h2>
            <p>Update <code>backend/src/workers/migrationWorker.ts</code>:</p>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;">
import { migrationQueue } from '../queues/migrationQueue';<br>
import { ETLService } from '../services/etlService';<br>
import { pool } from '../config/database';<br><br>

const etlService = new ETLService();<br><br>

migrationQueue.process(async (job) => {<br>
&nbsp;&nbsp;const { mappingId, connectionId } = job.data;<br>
&nbsp;&nbsp;const migrationId = `migration_${job.id}`;<br><br>

&nbsp;&nbsp;console.log(`Starting ETL job ${job.id}`);<br><br>

&nbsp;&nbsp;try {<br>
&nbsp;&nbsp;&nbsp;&nbsp;// Get mapping configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;const mappingResult = await pool.query(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'SELECT source_object, transforms FROM field_mappings WHERE id = $1',<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[mappingId]<br>
&nbsp;&nbsp;&nbsp;&nbsp;);<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;if (mappingResult.rows.length === 0) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new Error('Mapping not found');<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;const { source_object, transforms } = mappingResult.rows[0];<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;// EXTRACT<br>
&nbsp;&nbsp;&nbsp;&nbsp;await job.progress(10);<br>
&nbsp;&nbsp;&nbsp;&nbsp;const records = await etlService.extractFromSalesforce(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connectionId,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_object,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1000<br>
&nbsp;&nbsp;&nbsp;&nbsp;);<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;// TRANSFORM<br>
&nbsp;&nbsp;&nbsp;&nbsp;await job.progress(40);<br>
&nbsp;&nbsp;&nbsp;&nbsp;const { transformed, errors } = await etlService.transformRecords(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;records,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transforms,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connectionId<br>
&nbsp;&nbsp;&nbsp;&nbsp;);<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;console.log(`Transformed ${transformed.length} records, ${errors.length} errors`);<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;// LOAD (in batches)<br>
&nbsp;&nbsp;&nbsp;&nbsp;const batchSize = 100;<br>
&nbsp;&nbsp;&nbsp;&nbsp;for (let i = 0; i &lt; transformed.length; i += batchSize) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const batch = transformed.slice(i, i + batchSize);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await etlService.loadToStaging(migrationId, batch);<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const progress = 40 + Math.floor((i / transformed.length) * 50);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await job.progress(progress);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;await job.progress(100);<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;return {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;success: true,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recordsProcessed: transformed.length,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recordsFailed: errors.length,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errors: errors.slice(0, 10) // First 10 errors only<br>
&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&nbsp;&nbsp;} catch (error: any) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;console.error(`Job ${job.id} failed:`, error);<br>
&nbsp;&nbsp;&nbsp;&nbsp;throw error;<br>
&nbsp;&nbsp;}<br>
});<br><br>

migrationQueue.on('completed', (job, result) => {<br>
&nbsp;&nbsp;console.log(`Job ${job.id} completed:`, result);<br>
});<br><br>

migrationQueue.on('failed', (job, err) => {<br>
&nbsp;&nbsp;console.error(`Job ${job?.id} failed after ${job?.attemptsMade} attempts:`, err.message);<br>
});<br><br>

console.log('Migration worker started with ETL pipeline');
            </div>
        </div>

        <div class="step-card">
            <h2>üóÑÔ∏è Step 3: Create STG1 Migration Table</h2>
            <p>Create <code>backend/src/migrations/005_create_stg1_table.sql</code>:</p>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;">
CREATE TABLE IF NOT EXISTS stg1_records (<br>
&nbsp;&nbsp;id SERIAL PRIMARY KEY,<br>
&nbsp;&nbsp;migration_id VARCHAR(255) NOT NULL,<br>
&nbsp;&nbsp;source_id VARCHAR(255),<br>
&nbsp;&nbsp;data JSONB NOT NULL,<br>
&nbsp;&nbsp;created_at TIMESTAMP DEFAULT NOW(),<br>
&nbsp;&nbsp;INDEX idx_migration_id (migration_id),<br>
&nbsp;&nbsp;INDEX idx_source_id (source_id)<br>
);
            </div>
            <p>Run migration:</p>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;">
cd backend<br>
psql -U revnova -d revnova -f src/migrations/005_create_stg1_table.sql
            </div>
        </div>

        <div class="step-card">
            <h2>üß™ Step 4: Test ETL Pipeline</h2>
            <div style="background:#2d2d2d;color:#f8f8f2;padding:1rem;border-radius:6px;font-family:monospace;margin:1rem 0;">
# Submit ETL job with real mapping<br>
curl -X POST http://localhost:3000/api/jobs \<br>
&nbsp;&nbsp;-H "Content-Type: application/json" \<br>
&nbsp;&nbsp;-d '{<br>
&nbsp;&nbsp;&nbsp;&nbsp;"mappingId": "real-mapping-id",<br>
&nbsp;&nbsp;&nbsp;&nbsp;"connectionId": "real-connection-id"<br>
&nbsp;&nbsp;}'<br><br>

# Monitor job status<br>
curl http://localhost:3000/api/jobs/1<br><br>

# Check backend logs for:<br>
# "Extracting from Account (limit: 1000)..."<br>
# "Extracted 1000 records"<br>
# "Transformed 998 records, 2 errors"<br>
# "Loaded 100 records to STG1"<br>
# "Job 1 completed: { success: true, recordsProcessed: 998, recordsFailed: 2 }"<br><br>

# Verify staging table<br>
psql -U revnova -d revnova -c "SELECT COUNT(*), migration_id FROM stg1_records GROUP BY migration_id;"
            </div>
        </div>

        <div class="step-card">
            <h2>‚úÖ End of Day 19 Checklist</h2>
            <ul>
                <li>‚úÖ <code>backend/src/services/etlService.ts</code> created with extract, transform, load methods</li>
                <li>‚úÖ <code>backend/src/workers/migrationWorker.ts</code> updated with full ETL pipeline</li>
                <li>‚úÖ <code>stg1_records</code> table created in PostgreSQL with indexes</li>
                <li>‚úÖ Worker extracts data from Salesforce via jsforce SOQL</li>
                <li>‚úÖ Transformations applied using TransformService from Day 17</li>
                <li>‚úÖ Records loaded to STG1 in batches of 100</li>
                <li>‚úÖ Job progress updates every batch: 10% ‚Üí 40% ‚Üí 90% ‚Üí 100%</li>
                <li>‚úÖ Errors logged but processing continues (failedRecords in result)</li>
                <li>‚úÖ Test job completes successfully with recordsProcessed count</li>
                <li>‚úÖ All changes committed: <code>feat(backend): implement ETL pipeline with extract, transform, load to STG1</code></li>
            </ul>
        </div>
        <div class="nav-buttons"><a href="dev1-day18.html" class="nav-btn back">‚Üê Back to Day 18</a><a href="dev1-day20.html" class="nav-btn next">Next: Day 20 ‚Üí</a></div>
            </main>
    </div>
    <script src="../script.js"></script>
</body>
</html>
